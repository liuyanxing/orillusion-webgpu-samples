import"./modulepreload-polyfill.c7c6310f.js";import{b as B}from"./basic.vert.adc01c29.js";import{v as w,a as G}from"./cube.aa091a3d.js";import{b as y}from"./math.c29ca26c.js";import"./mat4.f7fc816f.js";const E=`@group(1) @binding(0) var Sampler: sampler;
@group(1) @binding(1) var Texture: texture_2d<f32>;
@group(1) @binding(2) var<uniform> uvOffset : vec4<f32>;

@fragment
fn main(@location(0) fragUV: vec2<f32>,
        @location(1) fragPosition: vec4<f32>) -> @location(0) vec4<f32> {
  // only show specific uv area of the big texture
  var uv = fragUV * vec2<f32>(uvOffset[2], uvOffset[3]) + vec2<f32>(uvOffset[0], uvOffset[1]);
  return textureSample(Texture, Sampler, uv) * fragPosition;
}
`,S="/orillusion-webgpu-samples/sprites.webp";async function C(e){if(!navigator.gpu)throw new Error("Not Support WebGPU");const t=await navigator.gpu.requestAdapter();if(!t)throw new Error("No Adapter Found");const i=await t.requestDevice(),n=e.getContext("webgpu"),r=navigator.gpu.getPreferredCanvasFormat?navigator.gpu.getPreferredCanvasFormat():n.getPreferredFormat(t),a=window.devicePixelRatio||1;e.width=e.clientWidth*a,e.height=e.clientHeight*a;const o={width:e.width,height:e.height};return n.configure({device:i,format:r,alphaMode:"opaque"}),{device:i,context:n,format:r,size:o}}async function R(e,t,i){const n=await e.createRenderPipelineAsync({label:"Basic Pipline",layout:"auto",vertex:{module:e.createShaderModule({code:B}),entryPoint:"main",buffers:[{arrayStride:20,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x2"}]}]},fragment:{module:e.createShaderModule({code:E}),entryPoint:"main",targets:[{format:t}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}}),r=e.createTexture({size:i,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),a=r.createView(),o=e.createBuffer({label:"GPUBuffer store vertex",size:w.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(o,0,w);const f=e.createBuffer({label:"GPUBuffer store 4x4 matrix",size:4*4*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),s=e.createBindGroup({label:"Uniform Group with Matrix",layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:f}}]});return{pipeline:n,vertexBuffer:o,mvpBuffer:f,uniformGroup:s,depthTexture:r,depthView:a}}function M(e,t,i,n){const r=e.createCommandEncoder(),a={colorAttachments:[{view:t.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:i.depthView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}},o=r.beginRenderPass(a);o.setPipeline(i.pipeline),o.setBindGroup(0,i.uniformGroup),o.setBindGroup(1,n),o.setVertexBuffer(0,i.vertexBuffer),o.draw(G),o.end(),e.queue.submit([r.finish()])}async function V(){const e=document.querySelector("canvas");if(!e)throw new Error("No Canvas");const{device:t,context:i,format:n,size:r}=await C(e),a=await R(t,n,r),f=await(await fetch(S)).blob(),s=await createImageBitmap(f),d=[s.width,s.height],g=t.createTexture({size:d,format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});t.queue.copyExternalImageToTexture({source:s},{texture:g},d);const v=t.createSampler({magFilter:"linear",minFilter:"linear"}),u=new Float32Array([0,0,1/3,1/2]),c=t.createBuffer({label:"GPUBuffer store UV offset",size:4*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});t.queue.writeBuffer(c,0,u);const P=t.createBindGroup({label:"Texture Group with Texture/Sampler",layout:a.pipeline.getBindGroupLayout(1),entries:[{binding:0,resource:v},{binding:1,resource:g.createView()},{binding:2,resource:{buffer:c}}]});let h=r.width/r.height;const T={x:0,y:0,z:-5},b={x:1,y:1,z:1},p={x:0,y:0,z:0};let l=0;function m(){l++,l%30===0&&(u[0]=u[0]>=2/3?0:u[0]+1/3,l%90===0&&(u[1]=u[1]>=1/2?0:u[1]+1/2),t.queue.writeBuffer(c,0,u));const x=Date.now()/1e3;p.x=Math.sin(x),p.y=Math.cos(x);const U=y(h,T,p,b);t.queue.writeBuffer(a.mvpBuffer,0,U.buffer),M(t,i,a,P),requestAnimationFrame(m)}m(),window.addEventListener("resize",()=>{r.width=e.width=e.clientWidth*devicePixelRatio,r.height=e.height=e.clientHeight*devicePixelRatio,a.depthTexture.destroy(),a.depthTexture=t.createTexture({size:r,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),a.depthView=a.depthTexture.createView(),h=r.width/r.height})}V();
